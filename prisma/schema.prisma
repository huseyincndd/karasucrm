// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =====================
// USER (Ekip Üyeleri)
// =====================
// Artık sabit bir "Rol" yok, "Yetenekler" (Capabilities) var.
model User {
  id         String   @id @default(cuid())
  username   String   @unique  // Giriş kullanıcı adı
  password   String   // Hashlenmiş şifre
  name       String   // Ad Soyad

  // Yeni Yapı
  roleTitle  String   // Görünen Etiket (Örn: "Yazılım Mühendisi", "Sosyal Medya Yöneticisi")
  baseSalary Float    @default(0) // Sabit Maaş (Ay sonu otomatik eklenir)
  
  isAdmin    Boolean  @default(false)
  avatar     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // İlişkiler
  capabilities       UserCapability[]    // Personelin yapabildiği işler ve fiyatları
  walletTransactions WalletTransaction[] // Para hareketleri
  tasks              Task[]              // Atanan görevler
  services           ClientService[]     // Verdiği hizmetler

  // Müşteri Sorumlulukları (Hangi müşterinin neyinden sorumlu?)
  responsibleForSocial   Client[] @relation("SocialResponsible")
  responsibleForDesign   Client[] @relation("DesignResponsible")
  responsibleForReels    Client[] @relation("ReelsResponsible")
  responsibleForAds      Client[] @relation("AdsResponsible")
}

// =====================
// USER CAPABILITY (Yetenek Matrisi)
// =====================
// Örn: Bu user "Reels" yapabilir ve tanesi "200 TL"dir.
model UserCapability {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   String // Yetenek Tipi: 'reels', 'post', 'meta_ads_15', 'meta_ads_30', 'graphic', 'social_management'
  price  Float  // Bu iş için alacağı birim ücret (veya dönemlik ücret)

  @@unique([userId, type]) // Bir kişinin aynı yetenekten iki tane olamaz
}

// =====================
// CLIENT (Müşteriler)  
// =====================
model Client {
  id          String   @id @default(cuid())
  name        String
  logo        String?
  packageType String   // vitrin, plus, premium
  
  // Custom Quota (Optional)
  reelsQuota   Int?
  postsQuota   Int?
  storiesQuota Int?
  
  startDate   DateTime
  renewalDate DateTime

  // Müşteri Portalı Girişi
  username    String?  @unique
  password    String?

  // 1. Sosyal Medya Yöneticileri (Genel Sorumlu)
  socialUsers   User[]   @relation("SocialResponsible")

  // 2. Grafik Tasarımcılar (Post/Story Görselleri)
  designerUsers User[]   @relation("DesignResponsible")

  // 3. Reels Video Uzmanları
  reelsUsers    User[]   @relation("ReelsResponsible")

  // 4. Meta Reklam Uzmanları
  adsUsers      User[]   @relation("AdsResponsible")

  adsPeriod    String? // Reklam Dönemi: "1-15", "1-30"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks    Task[]
  services ClientService[]
}

// =====================
// TASK (Görevler)
// =====================
model Task {
  id          String   @id @default(cuid())
  title       String?
  contentType String   // reels, posts, stories (Frontend'de kullanılan tip)
  date        DateTime
  status      String   @default("beklemede") // beklemede, hazir, tamamlandi
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clientId   String
  client     Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  assignedTo String
  assignee   User   @relation(fields: [assignedTo], references: [id], onDelete: Cascade)

  // Bu görevden doğan cüzdan işlemi
  walletTransaction WalletTransaction?

  @@index([date])
  @@index([status])
  @@index([assignedTo])
  @@index([clientId])
}

// =====================
// WALLET TRANSACTION (Cüzdan)
// =====================
model WalletTransaction {
  id          String   @id @default(cuid())
  amount      Float
  contentType String   // reels, posts, maas_odemesi, vb.
  description String
  createdAt   DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  taskId String? @unique // Tekrar unique yapıldı
  task   Task?   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  serviceId String?
  service   ClientService? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
}

// =====================
// CLIENT SERVICE (Hizmet Yönetimi)
// =====================
model ClientService {
  id          String   @id @default(cuid())
  
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  userId      String   // Hizmeti veren personel
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  serviceType String   // "meta_ads", "social_media_management"
  startDate   DateTime
  endDate     DateTime
  days        Int      // Kaç günlük
  
  price       Float    // O günkü hizmet bedeli
  isPaid      Boolean  @default(true) // Oluşturulduğu an ödendi sayılır (Cüzdana işlenir)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Bu hizmete bağlı cüzdan hareketi
  walletTransactions WalletTransaction[]
}
